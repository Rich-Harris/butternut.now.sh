<div class='left'>
	<textarea bind:value='source'></textarea>
</div>

<div class='right'>
	<textarea ref:output></textarea>
</div>

<style>
	.left, .right {
		position: relative;
		width: 50%;
		height: 100%;
		float: left;
	}

	textarea {
		position: absolute;
		width: 100%;
		height: 100%;
		outline: none;
		box-sizing: border-box;
		padding: 0.5em;
		font-size: inherit;
		font-family: monospace;
		resize: none;
	}
</style>

<script>
	import { getSourceFromGist, saveSourceAsGist } from './utils/gist.js';

	const versionMatch = typeof window !== 'undefined' ? /version=([^&]+)/.exec( window.location.search ) : null;
	const version = versionMatch ? versionMatch[1] : 'latest';

	export default {
		data () {
			const gistMatch = typeof window !== 'undefined' ? /gist=(.+)/.exec( window.location.search ) : null;
			const gist = gistMatch ? gistMatch[1] : null;

			return { source: '', gist };
		},

		oncreate () {
			const worker = new Worker('/worker.js');

			worker.addEventListener('message', event => {
				switch (event.data.type) {
					case 'init':
						this.set({ version: event.data.version });
						this.updateUrl();
						break;

					case 'result':
						// TODO https://github.com/sveltejs/svelte/issues/582
						this.refs.output.value = event.data.squashed;
						break;

					case 'error':
						console.error(event.data.message);
						break;
				}
			});

			this.observe( 'source', source => {
				worker.postMessage({
					type: 'source',
					source
				});
			});

			const gist = this.get( 'gist' );
			if ( gist ) {
				getSourceFromGist( gist ).then( source => {
					this.set({ source });
				});
			}

			window.addEventListener( 'keydown', event => {
				if ( event.which === 83 && event.metaKey ) {
					event.preventDefault();
					this.save();
				}
			});
		},

		methods: {
			updateUrl () {
				const { version, gist } = this.get();

				let url = `/?version=${version}`;
				if ( gist ) url += `&gist=${gist}`;

				history.replaceState({}, 'x', url);
			},

			save () {
				saveSourceAsGist( this.get( 'source' ) ).then( gist => {
					this.set({ gist });
					this.updateUrl();
				});
			}
		}
	};
</script>